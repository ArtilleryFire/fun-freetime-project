require("dotenv").config();
const puppeteer = require("puppeteer");
const axios = require("axios");



//WAFUNCH

async function sendWhatsApp(message) {
    const phone = process.env.WHATSAPP_NUMBER;
    const apiKey = process.env.WHATSAPP_APIKEY;

    const url = `https://api.callmebot.com/whatsapp.php?phone=${phone}&text=${encodeURIComponent(
        message
    )}&apikey=${apiKey}`;

    try {
        await axios.get(url);
        console.log("[WA] Terkirim:", message);
    } catch (err) {
        console.log("[WA] Gagal kirim:", err.message);
    }
}


// Main Function
async function autoBook() {
    const browser = await puppeteer.launch({
        headless: true
    });

    const page = await browser.newPage();

    try {
        console.log("Login Try");
        await page.goto("https://performancelab.my.id", {
            waitUntil: "networkidle2"
        });

        // LOGIN
        await page.type('#kode', process.env.MEMBER_NUMBER);
        await page.type('#nama', process.env.MEMBER_NAME);

        await page.click('button[type="submit"]');
        await page.waitForNavigation({
            waitUntil: "networkidle2"
        });

        console.log("Login sukses!");
        await sendWhatsApp("ü§ñ Bot aktif!\nMemulai auto-booking jadwal *besok*...");

        // PILIH "BESOK"
        await page.waitForSelector('.date-btn[data-day="tomorrow"]');
        await page.click('.date-btn[data-day="tomorrow"]');

        console.log("Memilih jadwal BESOK...");

        // PRIORITAS ID SESI
        const priorityOrder = [6, 5, 4, 3, 2, 1];

        // Retry
        while (true) {
            console.log("Check Session");
            await page.waitForSelector('.session-slot');

            let booked = false;

            for (const sessionId of priorityOrder) {
                const selector = `.session-slot.available[data-session-id="${sessionId}"]`;

                const sessionSlot = await page.$(selector);

                if (sessionSlot) {
                    const btn = await sessionSlot.$('button');

                    if (btn) {
                        console.log(`Sesi ${sessionId} tersedia! Mencoba booking...`);
                        await btn.click();

                        // SUCCESS MESSAGE
                        const msg =
`üéâ BOOKING BERHASIL!
Sesi: ${sessionId}
Tanggal: BESOK`;

                        console.log(msg);
                        await sendWhatsApp(msg);

                        booked = true;
                        break;
                    }
                } else {
                    console.log(`Sesi ${sessionId} penuh / tidak tersedia.`);
                }
            }

            if (booked) break;

            // JIKA GAGAL, RETRY 3 DETIK
            console.log("Belum ada sesi yang kosong. Retry 3 detik...");
            await sendWhatsApp("‚è≥ Retry... Semua sesi penuh. Cek lagi dalam 5 detik.");

            await new Promise(res => setTimeout(res, 5000));

            // REFRESH PAGE
            await page.reload({ waitUntil: "networkidle2" });
            await page.waitForSelector('.date-btn[data-day="tomorrow"]');
            await page.click('.date-btn[data-day="tomorrow"]');
        }

        await page.waitForTimeout(2000);
        await browser.close();

    } catch (err) {
        console.error("Error:", err);
        await sendWhatsApp("‚ùå ERROR!\n" + err.message);
        await browser.close();
    }
}


// =========================
// RUN THE SCRIPT
// =========================
autoBook();
